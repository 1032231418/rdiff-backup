= How to debug rdiff-backup?

== Trace back a coredump

As I write those notes, I have an issue where calling the program generates a `Segmentation fault (core dumped)`. At this stage, this document is just some notes taken as I'm trying to debug this problem under Fedora (29).

References:

* https://ask.fedoraproject.org/en/question/98776/where-is-core-dump-located/
* Adventures in Python core dumping: https://gist.github.com/toolness/d56c1aab317377d5d17a
* Debugging dynamically loaded extensions: https://www.oreilly.com/library/view/python-cookbook/0596001673/ch16s08.html
* Debugging Memory Problems: https://www.oreilly.com/library/view/python-cookbook/0596001673/ch16s09.html

NOTE: I assume gdb was already installed.

------------------------------------------------------------------------
sudo dnf install python3-debug
sudo dnf debuginfo-install python3-debug-3.7.3-1.fc29.x86_64 #<1>
sudo dnf debuginfo-install bzip2-libs-1.0.6-28.fc29.x86_64 glibc-2.28-27.fc29.x86_64 \
	librsync-1.0.0-8.fc29.x86_64 libxcrypt-4.4.4-2.fc29.x86_64 \
	openssl-libs-1.1.1b-3.fc29.x86_64 popt-1.16-15.fc29.x86_64 \
	sssd-client-2.1.0-2.fc29.x86_64 xz-libs-5.2.4-3.fc29.x86_64 zlib-1.2.11-14.fc29.x86_64
------------------------------------------------------------------------
<1> see below for the purpose of this and the following lines

Then calling:

------------------------------------------------------------------------
python3 dist/setup.py clean --all  #<1>
python3-debug dist/setup.py clean --all
CFLAGS='-Wall -O0 -g' python3-debug dist/setup.py build  #<2>
PYTHONPATH=build/lib.linux-x86_64-3.7-pydebug/ build/scripts-3.7/rdiff-backup -v 10 \
	/some/dir1 /some/dir2
[...]
Segmentation fault (core dumped)
------------------------------------------------------------------------
<1> just to be sure
<2> the CFLAGS avoids optimizations making debugging more complicated

At this stage `coredumpctl list` shows me that my coredump is the last one, so that I can
call `coredumpctl gdb`, which itself tells me (in multiple steps) that I'm missing some
more debug information, hence the above `debuginfo-install` statements (I guess you could install
the packages without version information if you're sure they fit the installed package versions).

So now back into `coredumpctl gdb`, with some commands because I'm no gdb specialist:

------------------------------------------------------------------------
help
help stack
backtrace
py-bt
[...]
------------------------------------------------------------------------


== ResourceWarning unclosed file

------------------------------------------------------------------------
/home/ericl/Public/rdiff-backup/build/lib.linux-x86_64-3.7-pydebug/rdiff_backup/robust.py:32: ResourceWarning: unclosed file <_io.BufferedReader name='/var/tmp/rdiff/rdiff-backup-data/increments/bla.2019-04-20T11:59:45+02:00.diff.gz'>
  try: return function(*args)
ResourceWarning: Enable tracemalloc to get the object allocation traceback

/home/ericl/Public/rdiff-backup/build/lib.linux-x86_64-3.7-pydebug/rdiff_backup/rorpiter.py:99: ResourceWarning: unclosed file <_io.BufferedReader name='/var/tmp/rdiff/rdiff-backup-data/mirror_metadata.2019-04-20T11:59:45+02:00.snapshot.gz'>
  try: relem2 = next(riter2)
ResourceWarning: Enable tracemalloc to get the object allocation traceback

/home/ericl/Public/rdiff-backup/build/lib.linux-x86_64-3.7-pydebug/rdiff_backup/robust.py:32: ResourceWarning: unclosed file <_io.BufferedReader name='/var/tmp/rdiff/bla'>
  try: return function(*args)
ResourceWarning: Enable tracemalloc to get the object allocation traceback

/home/ericl/Public/rdiff-backup/build/lib.linux-x86_64-3.7-pydebug/rdiff_backup/rpath.py:1202: ResourceWarning: unclosed file <_io.BufferedWriter name='/var/tmp/rdiff/rdiff-backup-data/increments/bla.2019-04-20T11:59:45+02:00.diff.gz'>
  if outfp.close(): raise RPathException("Error closing file")
ResourceWarning: Enable tracemalloc to get the object allocation traceback
------------------------------------------------------------------------

Reference:: https://docs.python.org/3/library/tracemalloc.html

------------------------------------------------------------------------
PYTHONTRACEMALLOC=1 PYTHONPATH=build/lib.linux-x86_64-3.7-pydebug/ \
	build/scripts-3.7/rdiff-backup -v 10 /tmp/äłtèr /var/tmp/rdiff
------------------------------------------------------------------------

This tells you indeed where the file was opened: `Object allocated at (most recent call last)` but it didn't really help me get rid of the warning, hence https://github.com/ericzolf/rdiff-backup/issues/18 until further notice.
